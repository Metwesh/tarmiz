<c-container>
  <!-- Breadcrumb -->
  <c-row class="justify-content-center">
    <c-col md="8">
      <c-breadcrumb>
        <c-breadcrumb-item
          routerLink="/assets/list"
          style="cursor: pointer"
          color="primary"
        >
          Assets
        </c-breadcrumb-item>
        <c-breadcrumb-item active> Asset Details </c-breadcrumb-item>
      </c-breadcrumb>
    </c-col>
  </c-row>

  <!-- Asset Details -->
  <c-row class="justify-content-center">
    <c-col md="8">
      <c-card>
        <c-card-header
          class="d-flex justify-content-between align-items-center"
        >
          <strong>Asset Details</strong>
          <c-badge color="primary">
            @if (isAssetLoading) {
            <span cPlaceholderAnimation="glow">
              <span
                cPlaceholder
                style="width: 5rem; border-radius: 1rem"
              ></span>
            </span>
            } @else { ID: {{ asset?.assetId }} }
          </c-badge>
        </c-card-header>

        <c-card-body>
          <!-- General Info -->
          <c-card class="mb-3">
            <c-card-header><strong>General Info</strong></c-card-header>
            <c-card-body>
              <c-row [gutter]="4">
                <c-col lg="3" xs="6"><strong>Name:</strong></c-col>
                <c-col lg="3" xs="6">
                  @if (isAssetLoading) {
                  <span cPlaceholderAnimation="glow"
                    ><span
                      cPlaceholder
                      style="width: 5rem; border-radius: 1rem"
                    ></span
                  ></span>
                  } @else { {{ asset?.name }} }
                </c-col>

                <c-col lg="3" xs="6"><strong>Symbol:</strong></c-col>
                <c-col lg="3" xs="6">
                  @if (isAssetLoading) {
                  <span cPlaceholderAnimation="glow"
                    ><span
                      cPlaceholder
                      style="width: 5rem; border-radius: 1rem"
                    ></span
                  ></span>
                  } @else { {{ asset?.symbol }} }
                </c-col>

                <c-col lg="3" xs="6"><strong>Asset Type:</strong></c-col>
                <c-col lg="3" xs="6">
                  @if (isAssetLoading) {
                  <span cPlaceholderAnimation="glow"
                    ><span
                      cPlaceholder
                      style="width: 5rem; border-radius: 1rem"
                    ></span
                  ></span>
                  } @else { {{ asset?.assetTypeName }} }
                </c-col>

                <c-col lg="3" xs="6"><strong>Supply Type:</strong></c-col>
                <c-col lg="3" xs="6">
                  @if (isAssetLoading) {
                  <span cPlaceholderAnimation="glow"
                    ><span
                      cPlaceholder
                      style="width: 5rem; border-radius: 1rem"
                    ></span
                  ></span>
                  } @else { {{ asset?.supplyTypeName }} }
                </c-col>
              </c-row>
            </c-card-body>
          </c-card>

          <!-- Supply Info -->
          <c-card class="mb-3">
            <c-card-header><strong>Supply Info</strong></c-card-header>
            <c-card-body>
              <c-row [gutter]="4">
                <c-col lg="3" xs="6"><strong>Supply:</strong></c-col>
                <c-col lg="3" xs="6">
                  @if (isAssetLoading) {
                  <span cPlaceholderAnimation="glow"
                    ><span
                      cPlaceholder
                      style="width: 5rem; border-radius: 1rem"
                    ></span
                  ></span>
                  } @else { {{ asset?.supply | number : "1.0" }} }
                </c-col>

                <c-col lg="3" xs="6"><strong>Circulating:</strong></c-col>
                <c-col lg="3" xs="6">
                  @if (isAssetLoading) {
                  <span cPlaceholderAnimation="glow"
                    ><span
                      cPlaceholder
                      style="width: 5rem; border-radius: 1rem"
                    ></span
                  ></span>
                  } @else { {{ asset?.circulating | number : "1.0" }} }
                </c-col>
              </c-row>
            </c-card-body>
          </c-card>

          <!-- Models -->
          <c-card class="mb-3">
            <c-card-header><strong>Models</strong></c-card-header>
            <c-card-body>
              <c-row [gutter]="4">
                <c-col lg="3" xs="6"><strong>Pricing Model:</strong></c-col>
                <c-col lg="3" xs="6">
                  @if (isAssetLoading) {
                  <span cPlaceholderAnimation="glow"
                    ><span
                      cPlaceholder
                      style="width: 5rem; border-radius: 1rem"
                    ></span
                  ></span>
                  } @else { {{ asset?.pricingModelName }} }
                </c-col>

                <c-col lg="3" xs="6"><strong>Trading Model:</strong></c-col>
                <c-col lg="3" xs="6">
                  @if (isAssetLoading) {
                  <span cPlaceholderAnimation="glow"
                    ><span
                      cPlaceholder
                      style="width: 5rem; border-radius: 1rem"
                    ></span
                  ></span>
                  } @else { {{ asset?.tradingModelName }} }
                </c-col>

                <c-col lg="3" xs="6"><strong>Execution Model:</strong></c-col>
                <c-col lg="3" xs="6">
                  @if (isAssetLoading) {
                  <span cPlaceholderAnimation="glow"
                    ><span
                      cPlaceholder
                      style="width: 5rem; border-radius: 1rem"
                    ></span
                  ></span>
                  } @else { {{ asset?.executionModelName }} }
                </c-col>

                <c-col lg="3" xs="6"><strong>User Level:</strong></c-col>
                <c-col lg="3" xs="6">
                  @if (isAssetLoading) {
                  <span cPlaceholderAnimation="glow"
                    ><span
                      cPlaceholder
                      style="width: 5rem; border-radius: 1rem"
                    ></span
                  ></span>
                  } @else { {{ asset?.levelName }} }
                </c-col>
              </c-row>
            </c-card-body>
          </c-card>

          <!-- Contract -->
          <c-card>
            <c-card-header><strong>Contract Info</strong></c-card-header>
            <c-card-body>
              <c-row [gutter]="4">
                <c-col lg="3" xs="6"><strong>Contract:</strong></c-col>
                <c-col lg="9" xs="6">
                  <code class="text-success">
                    @if (isAssetLoading) {
                    <span cPlaceholderAnimation="glow"
                      ><span
                        cPlaceholder
                        style="width: 20rem; border-radius: 1rem"
                      ></span
                    ></span>
                    } @else { {{ asset?.contract }} }
                  </code>
                </c-col>
              </c-row>
            </c-card-body>
          </c-card>

          <!-- Asset State -->
          <c-row class="mt-4 justify-content-center">
            <c-col md="12">
              <c-card class="h-100">
                <c-card-header
                  class="d-flex align-items-center justify-content-between"
                >
                  <strong>Asset State</strong>
                  <c-card-header-actions>
                    <button
                      cButton
                      color="primary"
                      size="sm"
                      (click)="toggleAssetStateModal(asset?.stateId)"
                    >
                      Set State
                    </button>
                  </c-card-header-actions>
                </c-card-header>
                <c-card-body>
                  <p class="text-center">
                    @if (isAssetLoading) {
                    <span cPlaceholderAnimation="glow">
                      <span
                        cPlaceholder
                        style="width: 5rem; border-radius: 1rem"
                      ></span>
                    </span>
                    } @else { {{ asset?.stateName }} }
                  </p>
                </c-card-body>
              </c-card>
            </c-col>

            <!-- <c-col md="4">
              <c-card class="h-100">
                <c-card-header style="height: 3rem" class="d-flex align-items-center">
                  <strong>Extra Info</strong>
                </c-card-header>
        
                <c-card-body>
                  <p style="max-height: 3rem; overflow: auto; margin: 0">
                    @if (isAssetLoading) {
                    <span cPlaceholderAnimation="glow">
                      <span
                        cPlaceholder
                        style="width: 20rem; border-radius: 1rem"
                      ></span>
                    </span>
                    } @else { {{ asset?.extra || "N/A" }} }
                  </p>
                </c-card-body>
              </c-card>
            </c-col> -->
          </c-row>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>

  <!-- Prices table -->
  <c-row class="mt-4 justify-content-center">
    <c-col md="8">
      <c-card>
        <c-card-header
          class="d-flex align-items-center justify-content-between"
        >
          <strong>Prices</strong>
          <c-card-header-actions>
            <button
              cButton
              color="primary"
              size="sm"
              (click)="openPriceAddModal()"
            >
              Add Price
            </button>
          </c-card-header-actions>
        </c-card-header>
        <c-card-body>
          <table cTable [hover]="true" [responsive]="true" [striped]="true">
            <thead>
              <tr>
                <th>Market</th>
                <th>Currency</th>
                <th>Bid</th>
                <th>Ask</th>
                <th>Last Update Time</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              @if (isAssetLoading) { @for (placeholder of [0, 1, 2, 3, 4]; track
              placeholder) {
              <tr>
                <td>
                  <p cPlaceholderAnimation="glow" style="margin: 0">
                    <span
                      cCol="12"
                      cPlaceholder
                      style="border-radius: 1rem; width: 100%"
                    ></span>
                  </p>
                </td>
                <td>
                  <p cPlaceholderAnimation="glow" style="margin: 0">
                    <span
                      cCol="12"
                      cPlaceholder
                      style="border-radius: 1rem; width: 100%"
                    ></span>
                  </p>
                </td>
                <td>
                  <p cPlaceholderAnimation="glow" style="margin: 0">
                    <span
                      cCol="12"
                      cPlaceholder
                      style="border-radius: 1rem; width: 100%"
                    ></span>
                  </p>
                </td>
                <td>
                  <p cPlaceholderAnimation="glow" style="margin: 0">
                    <span
                      cCol="12"
                      cPlaceholder
                      style="border-radius: 1rem; width: 100%"
                    ></span>
                  </p>
                </td>
                <td>
                  <p cPlaceholderAnimation="glow" style="margin: 0">
                    <span
                      cCol="12"
                      cPlaceholder
                      style="border-radius: 1rem; width: 100%"
                    ></span>
                  </p>
                </td>
                <td>
                  <p cPlaceholderAnimation="glow" style="margin: 0">
                    <span
                      cCol="12"
                      cPlaceholder
                      style="border-radius: 1rem; width: 100%"
                    ></span>
                  </p>
                </td>
              </tr>
              } } @else if (!isAssetLoading && (!asset?.markets ||
              asset?.markets?.length === 0) ) {
              <tr style="margin-top: 10rem; margin-bottom: 10rem">
                <td
                  style="padding-top: 10rem; padding-bottom: 10rem"
                  colspan="6"
                  class="text-center"
                >
                  No prices available
                </td>
              </tr>
              } @else { @for (priceInfo of asset?.markets; track priceInfo.time)
              {
              <tr>
                <td>{{ priceInfo.marketNameFull }}</td>
                <td>{{ priceInfo.currencyCode }}</td>
                <td>{{ priceInfo.bid | number : "1.2-5" }}</td>
                <td>{{ priceInfo.ask | number : "1.2-5" }}</td>
                <td>
                  {{ priceInfo.time * 1000 | date : "short" }}
                </td>
                <td>
                  <div class="d-flex justify-content-end">
                    <button
                      cButton
                      color="primary"
                      size="sm"
                      (click)="togglePriceSetModal(priceInfo)"
                    >
                      Set Price
                    </button>
                  </div>
                </td>
              </tr>
              } }
            </tbody>
          </table>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>

  <!-- Price History -->
  <c-row class="mt-4 justify-content-center">
    <c-col md="8">
      <c-card class="mb-4">
        <c-card-header class="d-flex align-items-center flex-wrap gap-2">
          <span>Price History</span>
        </c-card-header>
        <c-card-body>
          @if (isLoadingPriceHistory) {
          <div
            class="d-flex justify-content-center align-items-center"
            style="height: 18.75rem"
          >
            <c-spinner />
          </div>
          } @else {
          <c-chart
            [type]="priceHistory.length === 1 ? 'bar' : 'line'"
            [data]="chartBarData"
            [options]="options"
            [height]="300"
          />
          }
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>

  <!-- Subscribers table -->
  <c-row class="my-4 justify-content-center">
    <c-col md="8">
      <c-card>
        <c-card-header>
          <strong>Subscribers</strong>
        </c-card-header>
        <c-card-body>
          <table cTable [hover]="true" [responsive]="true" [striped]="true">
            <thead>
              <tr>
                <th class="bg-body-tertiary">#</th>
                <th class="bg-body-tertiary">Subscriber</th>
                <th class="bg-body-tertiary">Balance</th>
                <th class="bg-body-tertiary">State</th>
              </tr>
            </thead>
            <tbody>
              @if (isSubscribersLoading) { @for (placeholder of [0, 1, 2, 3, 4];
              track placeholder) {
              <tr>
                <td>
                  <p cPlaceholderAnimation="glow" style="margin: 0">
                    <span
                      cCol="12"
                      cPlaceholder
                      style="border-radius: 1rem; width: 100%"
                    ></span>
                  </p>
                </td>
                <td>
                  <p cPlaceholderAnimation="glow" style="margin: 0">
                    <span
                      cCol="12"
                      cPlaceholder
                      style="border-radius: 1rem; width: 100%"
                    ></span>
                  </p>
                </td>
                <td>
                  <p cPlaceholderAnimation="glow" style="margin: 0">
                    <span
                      cCol="12"
                      cPlaceholder
                      style="border-radius: 1rem; width: 100%"
                    ></span>
                  </p>
                </td>
              </tr>
              } } @else if (!isSubscribersLoading && subscribers.length === 0 )
              {
              <tr style="margin-top: 10rem; margin-bottom: 10rem">
                <td
                  style="padding-top: 10rem; padding-bottom: 10rem"
                  colspan="4"
                  class="text-center"
                >
                  No subscribers available
                </td>
              </tr>
              } @else { @for (subscriber of subscribers; track
              subscriber.subscriber; let index = $index) {
              <tr>
                <td>{{ index + 1 }}</td>
                <td>
                  <code>{{ subscriber.subscriber.address }}</code>
                </td>
                <td>{{ subscriber.balance | number : "1.0" }}</td>
                <td>{{ subscriber.stateName }}</td>
              </tr>
              } }
            </tbody>
          </table>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>
</c-container>

<!-- Price setter modal -->
<app-price-set-modal
  [visible]="isPriceSetModalOpen"
  [formData]="priceSetFormData"
  (close)="closePriceSetModal()"
  (revalidate)="refetchAssetDetails()"
/>

<!-- Asset state setter modal -->
<app-set-asset-state-modal
  [visible]="isAssetStateModalOpen"
  [assetState]="assetState"
  (close)="closeAssetStateModal()"
  (revalidate)="refetchAssetDetails()"
/>

<app-price-add-modal
  [visible]="isPriceAddModalOpen"
  (revalidate)="refetchAssetDetails()"
  (close)="closePriceAddModal()"
/>
